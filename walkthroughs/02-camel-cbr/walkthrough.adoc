= 02 - Content Base Router

Using Content Base Router to filter messages.

== Introduction

Content Base Router (CBR) is a pattern from the Enterprise Integration Pattern. You will use CBR when you need 
to filter some result, like conditional statements if and switch in languages as Java.

The code below is a CBR sample from the Enterprise Integration Pattern website

    from("direct:in")
      .choice()
        .when(header("type").isEqualTo("widget"))
          .to("direct:widget")
        .when(header("type").isEqualTo("gadget"))
          .to("direct:gadget")
        .otherwise()
          .to("direct:other")

You will use a similar code in this lab. 

== Using CBR in the hello-route

Continuing to evolve the sample used in the lab *hello-router*. The previous lab generated a Order object 
and call a new route named *sendBook*. 

Let's implement this route, mocking a send of items Camel and ActiveMQ to different destinations.

    from("direct:sendBook")
        .choice()
            .when(simple("${body.item} == 'Camel'"))
                .log("Processing Camel book")
                .to("mock:camel-store")
            .when(simple("${body.item} == 'ActiveMQ'"))
                .log("Processing ActiveMQ book")                
                .to("mock:activemq-store");

We compare the *item* attribute of Order and based in it content we log some information and send it 
to a mock destination. 

Run and check if both messages *Processing Camel book* and *Processing ActiveMQ book* appear in the log.

== Content Base Router with REST 

There is a REST endpoint, listening to receive payments. To make it more didact I'm using GET instead of POST.

Some samples of the use of this REST endpoint:

* http://localhost:8080/camel/orders/pay?paymentMethod=credit
* http://localhost:8080/camel/orders/pay?paymentMethod=cash
* http://localhost:8080/camel/orders/pay?paymentMethod=invalid

Open the class *ContentBaseRouter.java* to implement this lab. 

Process the *paymentMethod* query parameter as a header.

. when it is equal to *credit*.
.. Print "Processing credit payment..." as a log message in console 
.. Set Message "[Credit Operation] Thank you for shopping with us" in the body 
. when it is equal to *cash*.
.. Print "Processing cash payment..." as a log message in console 
.. Set Message "[Cash Operation] Thank you for shopping with us" in the body 
. Otherwise 
.. Print "Payment error" as a log message in console
.. Payment error, try again choosing paymentMethod credit or cash

Check the answer below, try to do by yourself instead of just copy and paste.

    .choice()
        .when(header("paymentMethod").isEqualTo("credit"))
            .log("Processing credit payment...")
            .setBody(simple("[Credit Operation] Thanks for your purchased"))
        .when(header("paymentMethod").isEqualTo("cash"))
            .log("[Cash Operation] Processing debit payment...")
            .setBody(simple("[Cash Operation] Thanks for your purchased"))
    .otherwise()
        .log("Payment error")
        .setBody(simple("Payment error, try again choosing paymentMethod credit or cash"));

Congrats!